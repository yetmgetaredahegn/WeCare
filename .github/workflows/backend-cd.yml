name: Backend CD

on:
  workflow_run:
    workflows: ['Backend CI']
    types:
      - completed
  workflow_dispatch:
    inputs:
      run_id:
        description: 'CI workflow run ID to deploy from'
        required: false
        type: string

jobs:
  deploy:
    runs-on: ubuntu-latest
    if: >-
      github.event_name == 'workflow_dispatch' ||
      (github.event.workflow_run.conclusion == 'success' && github.event.workflow_run.head_branch == 'main')

    steps:
      - name: Resolve workflow run id
        id: run_id
        run: |
          if [ "${{ github.event_name }}" = "workflow_run" ]; then
            echo "run_id=${{ github.event.workflow_run.id }}" >> $GITHUB_OUTPUT
            exit 0
          fi

          if [ -n "${{ inputs.run_id }}" ]; then
            echo "run_id=${{ inputs.run_id }}" >> $GITHUB_OUTPUT
            exit 0
          fi

          echo "Missing run_id for manual dispatch." >&2
          exit 1

      - name: Download test and coverage reports
        uses: actions/download-artifact@v4
        with:
          name: backend-quality-bundl
          path: backend-quality-bundl
          run-id: ${{ steps.run_id.outputs.run_id }}
          repository: ${{ github.repository }}
          github-token: ${{ secrets.GITHUB_TOKEN }}

      - name: Verify test report artifacts
        run: |
          test -f backend-quality-bundl/junit.xml
          test -f backend-quality-bundl/report.html
          test -f backend-quality-bundl/coverage.xml
          test -d backend-quality-bundl/htmlcov

      - name: Trigger Render deployment
        env:
          RENDER_SERVICE_ID: ${{ secrets.RENDER_SERVICE_ID }}
          RENDER_API_KEY: ${{ secrets.RENDER_API_KEY }}
        run: |
          curl -X POST \
            -H "Accept: application/json" \
            -H "Authorization: Bearer $RENDER_API_KEY" \
            -d "" \
            https://api.render.com/v1/services/$RENDER_SERVICE_ID/deploys
